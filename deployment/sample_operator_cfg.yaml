# orion adapter handler config
apiVersion: "config.istio.io/v1alpha2"
kind: handler
metadata:
 name: h1
 namespace: istio-system
spec:
 adapter: orionadapter
 connection:
   address: "orionadapterservice:43210"
 params:
  # Pub/pvt key pair. The adapter only uses the pub key at the moment
  # to validate inbound JTW tokens.
  # WARNING: test keys, never put prod ones here since this file sits
  # in GitHub!
  idsa_public_key: |
    -----BEGIN PUBLIC KEY-----
    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv
    vkTtwlvBsaJq7S5wA+kzeVOVpVWwkWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHc
    aT92whREFpLv9cj5lTeJSibyr/Mrm/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIy
    tvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0
    e+lf4s4OxQawWD79J9/5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb
    V6L11BWkpzGXSW4Hv43qa+GSYOD2QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9
    MwIDAQAB
    -----END PUBLIC KEY-----
  idsa_private_key: |
    -----BEGIN RSA PRIVATE KEY-----
    MIIEogIBAAKCAQEAnzyis1ZjfNB0bBgKFMSvvkTtwlvBsaJq7S5wA+kzeVOVpVWw
    kWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHcaT92whREFpLv9cj5lTeJSibyr/Mr
    m/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIytvHWTxZYEcXLgAXFuUuaS3uF9gEi
    NQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0e+lf4s4OxQawWD79J9/5d3Ry0vbV
    3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWbV6L11BWkpzGXSW4Hv43qa+GSYOD2
    QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9MwIDAQABAoIBACiARq2wkltjtcjs
    kFvZ7w1JAORHbEufEO1Eu27zOIlqbgyAcAl7q+/1bip4Z/x1IVES84/yTaM8p0go
    amMhvgry/mS8vNi1BN2SAZEnb/7xSxbflb70bX9RHLJqKnp5GZe2jexw+wyXlwaM
    +bclUCrh9e1ltH7IvUrRrQnFJfh+is1fRon9Co9Li0GwoN0x0byrrngU8Ak3Y6D9
    D8GjQA4Elm94ST3izJv8iCOLSDBmzsPsXfcCUZfmTfZ5DbUDMbMxRnSo3nQeoKGC
    0Lj9FkWcfmLcpGlSXTO+Ww1L7EGq+PT3NtRae1FZPwjddQ1/4V905kyQFLamAA5Y
    lSpE2wkCgYEAy1OPLQcZt4NQnQzPz2SBJqQN2P5u3vXl+zNVKP8w4eBv0vWuJJF+
    hkGNnSxXQrTkvDOIUddSKOzHHgSg4nY6K02ecyT0PPm/UZvtRpWrnBjcEVtHEJNp
    bU9pLD5iZ0J9sbzPU/LxPmuAP2Bs8JmTn6aFRspFrP7W0s1Nmk2jsm0CgYEAyH0X
    +jpoqxj4efZfkUrg5GbSEhf+dZglf0tTOA5bVg8IYwtmNk/pniLG/zI7c+GlTc9B
    BwfMr59EzBq/eFMI7+LgXaVUsM/sS4Ry+yeK6SJx/otIMWtDfqxsLD8CPMCRvecC
    2Pip4uSgrl0MOebl9XKp57GoaUWRWRHqwV4Y6h8CgYAZhI4mh4qZtnhKjY4TKDjx
    QYufXSdLAi9v3FxmvchDwOgn4L+PRVdMwDNms2bsL0m5uPn104EzM6w1vzz1zwKz
    5pTpPI0OjgWN13Tq8+PKvm/4Ga2MjgOgPWQkslulO/oMcXbPwWC3hcRdr9tcQtn9
    Imf9n2spL/6EDFId+Hp/7QKBgAqlWdiXsWckdE1Fn91/NGHsc8syKvjjk1onDcw0
    NvVi5vcba9oGdElJX3e9mxqUKMrw7msJJv1MX8LWyMQC5L6YNYHDfbPF1q5L4i8j
    8mRex97UVokJQRRA452V2vCO6S5ETgpnad36de3MUxHgCOX3qL382Qx9/THVmbma
    3YfRAoGAUxL/Eu5yvMK8SAt/dJK6FedngcM3JEFNplmtLYVLWhkIlNRGDwkg3I5K
    y18Ae9n7dHVueyslrb6weq7dTkYDi3iOYRW8HRkIQh06wEdbxt0shTzAJvvCQfrB
    jg/3747WSsf/zBTcHihTRBdAv6OmdhV4/dD5YBfLAkLrd+mX7iE=
    -----END RSA PRIVATE KEY-----
  id_token_json_template: |
    {
      "@type": "ids:ResultMessage",
      "id": "http://industrialdataspace.org/resultMessage/%s",
      "issued": "%s",
      "modelVersion": "2.1.0",
      "issuerConnector": "https://companyA.com/connector/59a68243-dd96-4c8d-88a9-0f0e03e13b1b",
      "securityToken": {
        "@type": "ids:DynamicAttributeToken",
        "tokenFormat": "https://w3id.org/idsa/code/tokenformat/JWT",
        "tokenValue": "%s"
      }
    }
  daps:
    server_host: "mockdaps.default:44300"
    connector_id: "4e16f007-d959-4eb2-b47d-78dd0c4eab0e"
    connector_audience: "https://consumerconnector.fiware.org"
    seconds_before_expiry: 3600
    #
    # mTLS certs and keys in PEM format:
    # * connector's own private key
    # * connector's own certificate to authenticate with DAPS; paired to
    #   the private key
    # * DAPS server certificate the connector should use to authenticate
    #   the server.
    #
    # To test with our DAPS mock server the below keys/certs have to
    # match those deployed with the mockdaps image, see:
    # * container/mockdaps.dockerfile
    # * deployment/daps/README.md
    #
    # WARNING: these are test keys/certs, never put prod ones here since
    # this file sits in GitHub!
    #
    private_key: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEpQIBAAKCAQEAl8saBGDth0LkrGrpYx3Up7u933TN4mjCZtofQfhKy5D1T6QW
      hkhPTTX0xyLwwNCd+ckzj6oImubI9glL4/7v+lqvXQDDyIwc8rSzQTDSsoLG1hJk
      JztYR08AQoercNuclvyc67c8mqYSsVO+VTChudTkena8H4VdT+LcaufbwUGCd7R8
      9uUjtco7mK66mxKbxh/wd9FNfWG8ky7QoSnRrAbGJCcNng1z1htaFE8IQtE3vn85
      uhPJBsvaQmUFX8AIxAVTblF74dnjlYH6hFnPfU+edH3lwiBRCM5Ur7Tqhorm1NcU
      krFKzGrA6CxlEKZJ7RgPZC9PCabBKjzvZRLQhQIDAQABAoIBAQCQJdPDLLjkpmW6
      Rpzz/zQfRW5+cdHCnHFgcusUHtIIltQemVi6lJiaXg7hvRCcSoB64NMSLwqU720Q
      GKv1C/ig6tV1oHBMVqJ26ZsA4Xh1BTQFvtlVWEnxDdjVVTk9p5AA4kuynQP0aJl/
      xGMPS2uJqd5/XZow5NlEL8/Zxe0ui60H0LXenBsYegLTUp6W/KzwVttPS+ID7wGt
      i3dpPV0EgTkKoz2iQ+libT7rBnTO3HL917EJNiuEmwK6R1QLjxZQhmjZ5bPsd6ye
      5tK7hNsE6HGgmjcqtovIKTOjunaPO7t3MfKJS3vm2PJKRWKcsHBtPwZwopE8Xs6i
      Lf+64gBRAoGBAMeb78QBk3YudwmFL0SPh9B8lQ0r3CZ1jkGaspGmOHpWJIRCFLXe
      MrtjwGPu5D5yqKNOfTfJHSuy5lA7dQyQm9Ej/ubg5CjOvAa1jZm4AZTXWAxrpvTQ
      smgCGfmVvkDZLejQthh90lH09OlW6VSreYvpsUfmS8eanzVJ01043fHrAoGBAMKt
      DL+9axuiDq+kzyuiwLqdnunJd97ASDYYEkPdMQ5n6FrxPZkQSgek7CywOstOEm0B
      aa+J1gicDSEIMiNpbfREHOTThmAt3ydude0e2ByY0qvYhC5X/k/28CHbGj4IC6bI
      udShEB0crTx/FQo7qp+VdiG1KxxK+syNH0aMfDtPAoGAfhjTYbZBKqJ1zozVbHFj
      seBR5K01eRJAWM9aSUqBWT87+FUqci25TMnaSwcqJw0V3XyC/A/PnsB4YGz/J33f
      AULFD6M4X1MiUva0SkyEqztSwx3qrbN9UNkrAZGIS70nFHFs55HsoJuncBTYeAWP
      VkS+Gpawfpr+QpKttLFs/BsCgYEAmpSchffbf8Kr1K6STnzaepREJjFyvG6EKGfu
      wPJ3TJAXgXcDSXIUxoMfgdChruOcX+/6Qoe5a3a2Oh9u6I2D4KzhIJYRondqNb5R
      Z2rRgcubpRa0xrPaXRag0NFQwibTUakbXgpSaDtoF5x1UX3VWwhsGBHqXHnxMdFx
      HyzYTKMCgYEAtk92F0qo/3hbb/raesTRlIqhNiFIgFq9qevtwALtEcEcj+hTAVGV
      riEcvrfuGdOHnP3SHD/kVI6c8mh8WpqZ+f+ZSeG+F+WMBds0v7RqHZi5AwmLQQWV
      1/O+YrQJLvHGgLajyTNT3n5KmLh2qXuxJzU0QbGPGAXDLoEV4BnmmlI=
      -----END RSA PRIVATE KEY-----
    connector_certificate: |
      -----BEGIN CERTIFICATE-----
      MIIDhjCCAm4CCQCjAJ8YHrjCoTANBgkqhkiG9w0BAQsFADCBhDELMAkGA1UEBhMC
      WkExFTATBgNVBAgMDFdlc3Rlcm4gQ2FwZTESMBAGA1UEBwwJQ2FwZSBUb3duMRIw
      EAYDVQQKDAlSdXNrcyBMdGQxCzAJBgNVBAsMAk1hMSkwJwYDVQQDDCBvcmlvbmFk
      YXB0ZXJzZXJ2aWNlLmlzdGlvLXN5c3RlbTAeFw0yMDAxMTkxNjU3NDBaFw0zMDAx
      MTYxNjU3NDBaMIGEMQswCQYDVQQGEwJaQTEVMBMGA1UECAwMV2VzdGVybiBDYXBl
      MRIwEAYDVQQHDAlDYXBlIFRvd24xEjAQBgNVBAoMCVJ1c2tzIEx0ZDELMAkGA1UE
      CwwCTWExKTAnBgNVBAMMIG9yaW9uYWRhcHRlcnNlcnZpY2UuaXN0aW8tc3lzdGVt
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAl8saBGDth0LkrGrpYx3U
      p7u933TN4mjCZtofQfhKy5D1T6QWhkhPTTX0xyLwwNCd+ckzj6oImubI9glL4/7v
      +lqvXQDDyIwc8rSzQTDSsoLG1hJkJztYR08AQoercNuclvyc67c8mqYSsVO+VTCh
      udTkena8H4VdT+LcaufbwUGCd7R89uUjtco7mK66mxKbxh/wd9FNfWG8ky7QoSnR
      rAbGJCcNng1z1htaFE8IQtE3vn85uhPJBsvaQmUFX8AIxAVTblF74dnjlYH6hFnP
      fU+edH3lwiBRCM5Ur7Tqhorm1NcUkrFKzGrA6CxlEKZJ7RgPZC9PCabBKjzvZRLQ
      hQIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQAiQkBJ46qfeRJx4Fpq87+cgSORjts2
      AxonWW4anz8zhvH73Re5//1WlY5bXDB4Rpejm0LPZ/XzVI9kbULg4JYJd0p8eTr8
      oiab1XNI9M6WHBAzF/dWse3IXErlBQAESmX051AGEtLg74jZTC4oNCcfsBy4oYPL
      5QxIoDwBvmi+ntrXLRm/16Mb/UCQ7XXwP1lugvt9x96hHCTXK/83QK86ooZmchIi
      crXpKrVFy/oDLt9YIfT6KEtWmmquAIaA6UDc3UI7kqR2mmsYn/d3zy79CPT7NnpK
      THZ0oKtoMSSZS23DyuP3Q0K6JHXMfPBWKPaKSHLUMVaORvGZLmQ9cEvf
      -----END CERTIFICATE-----
    server_certificate: |
      -----BEGIN CERTIFICATE-----
      MIIDZDCCAkwCCQDCNCNDKeiHtjANBgkqhkiG9w0BAQsFADB0MQswCQYDVQQGEwJa
      QTEVMBMGA1UECAwMV2VzdGVybiBDYXBlMRIwEAYDVQQHDAlDYXBlIFRvd24xEjAQ
      BgNVBAoMCVJ1c2tzIEx0ZDELMAkGA1UECwwCTWExGTAXBgNVBAMMEG1vY2tkYXBz
      LmRlZmF1bHQwHhcNMjAwMTE5MTcyNTU4WhcNMzAwMTE2MTcyNTU4WjB0MQswCQYD
      VQQGEwJaQTEVMBMGA1UECAwMV2VzdGVybiBDYXBlMRIwEAYDVQQHDAlDYXBlIFRv
      d24xEjAQBgNVBAoMCVJ1c2tzIEx0ZDELMAkGA1UECwwCTWExGTAXBgNVBAMMEG1v
      Y2tkYXBzLmRlZmF1bHQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDR
      jww0dGZqcw+RMi42UzVhLaxIIch0tqly+ShU/o80Yx5FvTjX/oqHtFdtW086VASj
      ivKqGx1eZS/Um1j/gEGQmwOsHZz/nj2vJzqoy8HFolNHNpl1q0wyuheDS9+AWMiQ
      8seyOPlVBjCYLrH5V46P6Ae8YBQWjV57IMRkln3nvYTTNvtwQumLlRAEoxLbVxSG
      D5wfGYBaF+wLtlnkUheY2bw3qNmopQF7pUBfEhrSK0GDUTysGSdzPGMd5l3LYbPH
      sQI81z+JB+8jcLM6AdWLafXru3IK3XoAoNmmhxT6YREJHqK3mOhUCE4KmRM0M9ni
      vThYLnUv4xmsmSwaaCmlAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAEdvBudRwMN0
      vNeh88q0SUxkIpKX+wccNAnkvhmYw7IW7c+jclAoK9SYF/XYQJyOU2Z4SZHeFBQ2
      GlZMMvvaipgDxvH5qPylOB1J0ZFgvT6EOgLuOBAUPeafYRSQGAVmI0GYU9oG8MHL
      xGTzDPRswwmkm6AU5YVmKSc9oW+Eazt9heBkMxGzAZAXFWRjnZSVr3ku0HtmNWQ1
      lwCbkd9ft3IgKHTEfkdhooRCC2KK9p7ebpekRTJCs9sk/kKx+Z/yabuRiMq1X7Ku
      /NI6EwztmDPkmxtNpUh+oYSQ/3F/MzSmK4wmEqO1r7Qt4ubiC5ecikqw5la3bikj
      1PVAM126t14=
      -----END CERTIFICATE-----
---

# instance for authorization template
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
 name: icheck
 namespace: istio-system
spec:
 template: oriondata
 params:
   client_token: request.headers["header"]
---

# rule to dispatch to orion handler
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
 name: r1
 namespace: istio-system
spec:
 actions:
 - handler: h1.istio-system
   instances:
   - icheck
   name: adapter_response
 responseHeaderOperations:
  - name: header
    values: [ adapter_response.output.context_broker_token ]
---
